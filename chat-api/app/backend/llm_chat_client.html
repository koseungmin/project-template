<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Chat Client (REST API)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            background: #007bff;
            color: white;
        }
        .user-input-section {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            background: #f8f9fa;
        }
        .user-input-section input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .room-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .room-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            transition: background-color 0.2s;
            position: relative;
            min-height: 60px;
        }
        .room-item:hover {
            background: #e9ecef;
        }
        .room-item.active {
            background: #007bff;
            color: white;
        }
        .room-content {
            cursor: pointer;
            padding-right: 90px; /* Ìé∏Ïßë Î≤ÑÌäºÍ≥º ÏÇ≠Ï†ú Î≤ÑÌäºÏùÑ ÏúÑÌïú Í≥µÍ∞Ñ ÌôïÎ≥¥ */
        }
        .room-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 10;
            display: flex;
            gap: 5px;
        }
        .edit-room-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 10px;
            font-weight: bold;
            width: 35px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .edit-room-btn:hover {
            background: #218838;
            transform: scale(1.05);
        }
        .delete-room-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 10px;
            font-weight: bold;
            width: 35px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .delete-room-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }
        .room-name-input {
            width: 100%;
            padding: 4px 8px;
            border: 2px solid #007bff;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            background: white;
            outline: none;
        }
        .room-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .room-time {
            font-size: 12px;
            opacity: 0.7;
        }
        .room-preview {
            font-size: 12px;
            margin-top: 4px;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .new-room-btn {
            width: 100%;
            padding: 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .new-room-btn:hover {
            background: #218838;
        }
        .chat-container {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .chat-header {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            border-bottom: 1px solid #eee;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            max-width: 70%;
        }
        .user-message {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        .ai-message {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #dee2e6;
        }
        .system-message {
            background: #e9ecef;
            color: #6c757d;
            text-align: center;
            font-style: italic;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .chat-input {
            padding: 15px;
            display: flex;
            gap: 10px;
        }
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .chat-input button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .chat-input button:hover {
            background: #0056b3;
        }
        .chat-input button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .controls {
            padding: 10px 15px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
        }
        .controls button {
            padding: 5px 15px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        .controls button:hover {
            background: #5a6268;
        }
        .status {
            padding: 5px 15px;
            background: #d4edda;
            color: #155724;
            font-size: 14px;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #6c757d;
        }
        .progress-indicator {
            display: none;
            padding: 10px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            margin: 10px 0;
            border-radius: 4px;
        }
        .progress-indicator.show {
            display: block;
        }
        .ai-message-streaming {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #dee2e6;
            position: relative;
        }
        .ai-message-streaming::after {
            content: '‚ñã';
            animation: blink 1s infinite;
            color: #007bff;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .cancel-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        .cancel-button:hover {
            background: #c82333;
        }
        .cancelled-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            font-style: italic;
            opacity: 0.9;
        }
        .cancelled-message::before {
            content: "‚ö†Ô∏è ";
        }
        .upload-section {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            background: #f8f9fa;
        }
        .upload-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
        }
        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .upload-form input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }
        .file-input-label {
            display: inline-block;
            padding: 8px 16px;
            background: #17a2b8;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-align: center;
            transition: background-color 0.2s;
        }
        .file-input-label:hover {
            background: #138496;
        }
        .upload-buttons {
            display: flex;
            gap: 8px;
        }
        .upload-btn {
            flex: 1;
            padding: 8px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .upload-btn:hover {
            background: #218838;
        }
        .upload-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .folder-select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        .upload-status {
            margin-top: 8px;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-text {
            text-align: center;
            font-weight: bold;
            color: #495057;
        }
        .upload-mode-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .upload-mode-selector label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 14px;
            color: #495057;
        }
        .upload-mode-selector input[type="radio"] {
            margin: 0;
        }
        .upload-mode {
            margin-bottom: 10px;
        }
        .selected-files {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .selected-files h5 {
            margin: 0 0 8px 0;
            color: #495057;
            font-size: 14px;
        }
        .selected-files ul {
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .selected-files li {
            padding: 4px 0;
            color: #6c757d;
            font-size: 13px;
            border-bottom: 1px solid #e9ecef;
        }
        .selected-files li:last-child {
            border-bottom: none;
        }
        .upload-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .upload-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .document-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            margin-top: 8px;
        }
        .document-item {
            padding: 8px 12px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        .document-item:last-child {
            border-bottom: none;
        }
        .document-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .document-actions {
            display: flex;
            gap: 4px;
        }
        .document-btn {
            padding: 2px 6px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        .download-btn {
            background: #007bff;
            color: white;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <!-- ÏÇ¨Ïù¥ÎìúÎ∞î -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>Ï±ÑÌåÖ Î™©Î°ù</h3>
        </div>
        <div class="user-input-section">
            <input type="text" id="userNameInput" placeholder="ÏÇ¨Ïö©ÏûêÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." value="user">
        </div>
        
        <!-- Î¨∏ÏÑú ÏóÖÎ°úÎìú ÏÑπÏÖò -->
        <div class="upload-section">
            <h4>üìÅ Î¨∏ÏÑú ÏóÖÎ°úÎìú</h4>
            <div class="upload-form">
                <!-- ÏóÖÎ°úÎìú Î∞©Ïãù ÏÑ†ÌÉù -->
                <div class="upload-mode-selector">
                    <label>
                        <input type="radio" name="uploadMode" value="file" checked onchange="toggleUploadMode()">
                        Í∞úÎ≥Ñ ÌååÏùº ÏÑ†ÌÉù
                    </label>
                    <label>
                        <input type="radio" name="uploadMode" value="folder" onchange="toggleUploadMode()">
                        Ìè¥Îçî Ï†ÑÏ≤¥ ÏóÖÎ°úÎìú
                    </label>
                </div>
                
                <!-- Í∞úÎ≥Ñ ÌååÏùº ÏóÖÎ°úÎìú -->
                <div id="fileUploadMode" class="upload-mode">
                    <input type="text" id="folderNameInput" placeholder="Ìè¥ÎçîÎ™Ö (ÏÑ†ÌÉùÏÇ¨Ìï≠)" />
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.xls,.xlsx" multiple />
                        <label for="fileInput" class="file-input-label">üìé ÌååÏùº ÏÑ†ÌÉù (Ïó¨Îü¨ Í∞ú Í∞ÄÎä•)</label>
                    </div>
                    <div id="selectedFiles" class="selected-files" style="display: none;">
                        <h5>ÏÑ†ÌÉùÎêú ÌååÏùº:</h5>
                        <ul id="fileList"></ul>
                    </div>
                </div>
                
                <!-- Ìè¥Îçî ÏóÖÎ°úÎìú -->
                <div id="folderUploadMode" class="upload-mode" style="display: none;">
                    <input type="text" id="folderPathInput" placeholder="Ìè¥Îçî Í≤ΩÎ°úÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: /Users/username/Documents)" />
                </div>
                
                <div class="upload-buttons">
                    <button class="upload-btn" onclick="uploadDocument()" id="uploadBtn">ÏóÖÎ°úÎìú</button>
                    <button class="upload-btn" onclick="loadDocuments()" id="refreshBtn">ÏÉàÎ°úÍ≥†Ïπ®</button>
                </div>
                <div id="uploadStatus" class="upload-status"></div>
                <div id="documentList" class="document-list" style="display: none;"></div>
                <div id="uploadProgress" class="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
            </div>
        </div>
        
        <div class="room-list">
            <button class="new-room-btn" onclick="createNewChat()">ÏÉà Ï±ÑÌåÖ ÎßåÎì§Í∏∞</button>
            <div id="roomList"></div>
        </div>
    </div>

    <!-- Ï±ÑÌåÖ ÏòÅÏó≠ -->
    <div class="chat-container">
        <div class="chat-header">
            <h2 id="currentRoomTitle">Ï±ÑÌåÖÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</h2>
            <div id="status" class="status">Ï§ÄÎπÑÎê®</div>
        </div>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="loading" id="loading">AIÍ∞Ä ÏùëÎãµÏùÑ ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...</div>
        <div class="progress-indicator" id="progressIndicator">
            <div id="progressMessage">AIÍ∞Ä ÏÉùÍ∞ÅÌïòÍ≥† ÏûàÏäµÎãàÎã§...</div>
            <button class="cancel-button" onclick="cancelGeneration()" id="cancelButton">Ï∑®ÏÜå</button>
        </div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." onkeypress="handleKeyPress(event)" disabled>
            <button onclick="sendMessage()" id="sendButton" disabled>Ï†ÑÏÜ°</button>
        </div>
    </div>

    <script>
        let currentChatId = null;
        let isLoading = false;
        let currentStreamingMessage = null;
        let abortController = null;
        let chats = [];
        let documents = [];
        let folders = [];

        // Ï±ÑÌåÖ Í¥ÄÎ†® Ìï®ÏàòÎì§
        async function loadChats() {
            try {
                const userName = document.getElementById('userNameInput').value || 'user';
                console.log('Loading chats for user:', userName);
                
                const response = await fetch(`/api/v1/chat/chats?user_id=${encodeURIComponent(userName)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Loaded chats data:', data);
                chats = data.chats || [];
                displayChats();
            } catch (error) {
                console.error('Error loading chats:', error);
                updateStatus('Ï±ÑÌåÖ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', true);
            }
        }

        function displayChats() {
            const roomListDiv = document.getElementById('roomList');
            console.log('Displaying chats, count:', chats.length);
            console.log('Chats data:', chats);
            
            roomListDiv.innerHTML = '';
            
            if (chats.length === 0) {
                roomListDiv.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">Ï±ÑÌåÖÏù¥ ÏóÜÏäµÎãàÎã§</div>';
                return;
            }
            
            chats.forEach(room => {
                const roomDiv = document.createElement('div');
                roomDiv.className = 'room-item';
                
                const time = room.last_message_at ? 
                    new Date(room.last_message_at).toLocaleString() : 
                    new Date(room.created_at).toLocaleString();
                
                roomDiv.innerHTML = `
                    <div class="room-content" onclick="selectChat('${room.chat_id}')">
                        <div class="room-name">${room.chat_title}</div>
                        <div class="room-time">${time}</div>
                        <div class="room-preview">Ï±ÑÌåÖ ID: ${room.chat_id}</div>
                    </div>
                    <div class="room-actions">
                        <button class="edit-room-btn" onclick="editChatTitle('${room.chat_id}', event)" title="Ïù¥Î¶Ñ Î≥ÄÍ≤Ω">‚úèÔ∏è</button>
                        <button class="delete-room-btn" onclick="deleteChat('${room.chat_id}', event)">ÏÇ≠Ï†ú</button>
                    </div>
                `;
                
                roomListDiv.appendChild(roomDiv);
            });
        }

        function selectChat(chatId) {
            // Ïù¥Ï†Ñ ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.room-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // ÏÉà ÏÑ†ÌÉù ÌôúÏÑ±Ìôî
            const roomElement = document.querySelector(`[onclick="selectChat('${chatId}')"]`);
            if (roomElement) {
                roomElement.closest('.room-item').classList.add('active');
            }
            
            currentChatId = chatId;
            
            // Ï±ÑÌåÖ ÏòÅÏó≠ ÌôúÏÑ±Ìôî
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            
            // Ï±ÑÌåÖ Ïù¥Î¶Ñ Ï∞æÍ∏∞
            const room = chats.find(r => r.room_id === chatId);
            const chatTitle = room ? room.chat_title : chatId;
            document.getElementById('currentRoomTitle').textContent = `Ï±ÑÌåÖ: ${chatTitle}`;
            
            // Ï±ÑÌåÖ Í∏∞Î°ù Î°úÎìú
            loadChatHistory();
        }

        async function deleteChat(chatId, event) {
            event.stopPropagation(); // Ïù¥Î≤§Ìä∏ Î≤ÑÎ∏îÎßÅ Î∞©ÏßÄ
            
            if (!confirm('Ï†ïÎßêÎ°ú Ïù¥ Ï±ÑÌåÖÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/chat/chats/${chatId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // ÏÇ≠Ï†úÎêú Ï±ÑÌåÖÏù¥ ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Ï±ÑÌåÖÏù¥Î©¥ Ï±ÑÌåÖ ÏòÅÏó≠ ÎπÑÌôúÏÑ±Ìôî
                if (currentChatId === chatId) {
                    currentChatId = null;
                    currentChatId = null;
                    document.getElementById('messageInput').disabled = true;
                    document.getElementById('sendButton').disabled = true;
                    document.getElementById('currentRoomTitle').textContent = 'Ï±ÑÌåÖÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî';
                    document.getElementById('chatMessages').innerHTML = '';
                }
                
                // Ï±ÑÌåÖ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                await loadChats();
                updateStatus('Ï±ÑÌåÖÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                
            } catch (error) {
                console.error('Error deleting room:', error);
                updateStatus('Ï±ÑÌåÖ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', true);
            }
        }

        async function createNewChat() {
            const chatTitle = prompt('Ï±ÑÌåÖ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', `Chat ${Date.now()}`);
            if (!chatTitle) return;
            
            try {
                console.log('Creating new chat with title:', chatTitle);
                const userName = document.getElementById('userNameInput').value || 'user';
                console.log('User name:', userName);
                
                const response = await fetch('/api/v1/chat/chats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_title: chatTitle,
                        user_id: userName
                    })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Created chat data:', data);
                
                // ÏÉà Ï±ÑÌåÖÏùÑ Î™©Î°ùÏóê Ï∂îÍ∞Ä
                chats.unshift({
                    chat_id: data.chat_id,
                    chat_title: data.chat_title,
                    user_id: data.user_id,
                    created_at: data.created_at,
                    last_message_at: null
                });
                
                displayChats();
                selectChat(data.chat_id);
                updateStatus('ÏÉà Ï±ÑÌåÖÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.');
                
            } catch (error) {
                console.error('Error creating chat:', error);
                updateStatus(`Ï±ÑÌåÖ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`, true);
            }
        }

        async function createNewChatFromMessage(message) {
            try {
                // LLMÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ ÏßàÎ¨∏ÏùÑ Í∏∞Î∞òÏúºÎ°ú Ï±ÑÌåÖ Ï†úÎ™© ÏÉùÏÑ±
                const chatTitle = await generateChatTitle(message);
                
                const userName = document.getElementById('userNameInput').value || 'user';
                const response = await fetch('/api/v1/chat/chats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_title: chatTitle,
                        user_id: userName
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // ÏÉà Ï±ÑÌåÖÏùÑ Î™©Î°ùÏóê Ï∂îÍ∞Ä
                chats.unshift({
                    chat_id: data.chat_id,
                    chat_title: data.chat_title,
                    user_id: data.user_id,
                    created_at: data.created_at,
                    last_message_at: null
                });
                
                displayChats();
                selectChat(data.chat_id);
                updateStatus('ÏÉà Ï±ÑÌåÖÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.');
                
            } catch (error) {
                console.error('Error creating room from message:', error);
                // Ïã§Ìå® Ïãú Í∏∞Î≥∏ Ï†úÎ™©ÏúºÎ°ú ÏÉùÏÑ±
                const fallbackName = `Chat ${Date.now()}`;
                await createNewChatWithName(fallbackName);
            }
        }

        async function createNewChatWithName(chatTitle) {
            try {
                const userName = document.getElementById('userNameInput').value || 'user';
                const response = await fetch('/api/v1/chat/chats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_title: chatTitle,
                        user_id: userName
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // ÏÉà Ï±ÑÌåÖÏùÑ Î™©Î°ùÏóê Ï∂îÍ∞Ä
                chats.unshift({
                    chat_id: data.chat_id,
                    chat_title: data.chat_title,
                    user_id: data.user_id,
                    created_at: data.created_at,
                    last_message_at: null
                });
                
                displayChats();
                selectChat(data.chat_id);
                
            } catch (error) {
                console.error('Error creating room:', error);
                updateStatus('Ï±ÑÌåÖ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', true);
            }
        }

        async function generateChatTitle(message) {
            try {
                // LLM APIÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Ï†úÎ™© ÏÉùÏÑ±
                const response = await fetch('/api/v1/chat/generate-title', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.title;
                
            } catch (error) {
                console.error('Error generating room title:', error);
                // Ïã§Ìå® Ïãú Í∞ÑÎã®Ìïú Ï†úÎ™© ÏÉùÏÑ±
                const words = message.split(' ').slice(0, 3);
                let title = words.join(' ');
                
                if (title.length > 15) {
                    title = title.substring(0, 12) + '...';
                }
                
                return title || `Chat ${new Date().toLocaleTimeString()}`;
            }
        }

        async function loadChatHistory() {
            if (!currentChatId) return;
            
            try {
                const response = await fetch(`/api/v1/chat/${currentChatId}/history`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displayHistory(data.history);
                
            } catch (error) {
                console.error('Error loading chat history:', error);
                updateStatus('Ï±ÑÌåÖ Í∏∞Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', true);
            }
        }

        function addMessage(content, type, timestamp, messageId = null, isCancelled = false) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            let className = `message ${type}-message`;
            if (isCancelled) {
                className += ' cancelled-message';
            }
            messageDiv.className = className;
            if (messageId) {
                messageDiv.id = `message-${messageId}`;
            }
            
            const time = new Date(timestamp).toLocaleTimeString();
            messageDiv.innerHTML = `
                <div>${content}</div>
                <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">${time}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return messageDiv;
        }

        function addSystemMessage(message) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system-message';
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function displayHistory(history) {
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = '';
            
            console.log(`Loading chat history for ${currentChatId}: ${history.length} messages`);
            
            history.forEach((msg, index) => {
                let type = msg.role === 'user' ? 'user' : 'ai';
                if (msg.role === 'system') {
                    type = 'system';
                }
                const isCancelled = msg.cancelled || false;
                console.log(`Message ${index + 1}: ${type} - ${msg.content.substring(0, 50)}...`);
                addMessage(msg.content, type, msg.timestamp, null, isCancelled);
            });
            
            updateStatus(`Ï±ÑÌåÖ Í∏∞Î°ù Î°úÎìú ÏôÑÎ£å: ${history.length}Í∞ú Î©îÏãúÏßÄ`);
        }

        function setLoading(loading) {
            isLoading = loading;
            document.getElementById('loading').style.display = loading ? 'block' : 'none';
            document.getElementById('sendButton').disabled = loading;
        }

        function setProgress(show, message = '') {
            const progressDiv = document.getElementById('progressIndicator');
            const progressMessage = document.getElementById('progressMessage');
            
            if (show) {
                progressDiv.classList.add('show');
                progressMessage.textContent = message;
            } else {
                progressDiv.classList.remove('show');
            }
        }

        function updateStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = isError ? 'status error' : 'status';
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isLoading) return;
            
            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Ï±ÑÌåÖÏù¥ ÏóÜÏúºÎ©¥ ÏÉà Ï±ÑÌåÖ ÏÉùÏÑ±
            if (!currentChatId) {
                await createNewChatFromMessage(message);
            }
            
            // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ ÌëúÏãú
            addMessage(message, 'user', new Date().toISOString());
            input.value = '';
            
            setLoading(true);
            setProgress(true, 'AIÍ∞Ä ÏÉùÍ∞ÅÌïòÍ≥† ÏûàÏäµÎãàÎã§...');
            updateStatus('AI ÏùëÎãµÏùÑ Í∏∞Îã§Î¶¨Îäî Ï§ë...');
            
            try {
                // Ïä§Ìä∏Î¶¨Î∞ç ÏöîÏ≤≠
                abortController = new AbortController();
                const response = await fetch(`/api/v1/chat/${currentChatId}/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'user_message',
                        message: message,
                        user_id: document.getElementById('userNameInput').value || 'user'
                    }),
                    signal: abortController.signal
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let aiMessageDiv = null;
                let aiContent = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // ÎßàÏßÄÎßâ Î∂àÏôÑÏ†ÑÌïú ÎùºÏù∏ÏùÄ Î≤ÑÌçºÏóê Î≥¥Í¥Ä
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                handleStreamData(data, aiMessageDiv, aiContent);
                                
                                if (data.type === 'ai_response_chunk') {
                                    if (!aiMessageDiv) {
                                        aiMessageDiv = addMessage('', 'ai', data.timestamp, data.message_id);
                                        aiMessageDiv.classList.add('ai-message-streaming');
                                        currentStreamingMessage = aiMessageDiv;
                                    }
                                    aiContent += data.content;
                                    aiMessageDiv.querySelector('div').textContent = aiContent;
                                } else if (data.type === 'ai_response_complete') {
                                    if (aiMessageDiv) {
                                        aiMessageDiv.classList.remove('ai-message-streaming');
                                        currentStreamingMessage = null;
                                    }
                                }
                            } catch (e) {
                                console.error('Error parsing stream data:', e);
                            }
                        }
                    }
                }
                
                updateStatus('Ï§ÄÎπÑÎê®');
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    addMessage('ÏÇ¨Ïö©ÏûêÏóê ÏùòÌï¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.', 'system', new Date().toISOString());
                    updateStatus('Ï∑®ÏÜåÎê®');
                } else {
                    console.error('Error:', error);
                    addMessage(`Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`, 'error', new Date().toISOString());
                    updateStatus('Ïò§Î•ò Î∞úÏÉù', true);
                }
            } finally {
                setLoading(false);
                setProgress(false);
                abortController = null;
            }
        }

        function handleStreamData(data, aiMessageDiv, aiContent) {
            switch(data.type) {
                case 'progress':
                    setProgress(true, data.message);
                    break;
                case 'cancelled':
                    addMessage(data.content || data.message, 'system', data.timestamp, data.message_id, true);
                    setProgress(false);
                    // Ï∑®ÏÜå Ïãú ÌòÑÏû¨ Ïä§Ìä∏Î¶¨Î∞ç Î©îÏãúÏßÄ Ï†ïÎ¶¨
                    if (currentStreamingMessage) {
                        currentStreamingMessage.classList.remove('ai-message-streaming');
                        currentStreamingMessage = null;
                    }
                    break;
                case 'info':
                    addSystemMessage(data.message);
                    break;
                case 'error':
                    addMessage(data.content, 'error', data.timestamp);
                    setProgress(false);
                    // ÏóêÎü¨ Î∞úÏÉù Ïãú ÏûÖÎ†• ÌïÑÎìú ÌôúÏÑ±Ìôî
                    document.getElementById('sendButton').disabled = false;
                    break;
            }
        }

        async function cancelGeneration() {
            if (abortController) {
                abortController.abort();
                
                // Î∞±ÏóîÎìúÏóêÎèÑ Ï∑®ÏÜå ÏöîÏ≤≠ Ï†ÑÏÜ° (Î©îÏãúÏßÄ Ï†ÄÏû•ÏùÑ ÏúÑÌï¥)
                try {
                    const response = await fetch(`/api/v1/chat/${currentChatId}/cancel`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        updateStatus(data.message);
                    }
                } catch (error) {
                    console.error('Error calling cancel API:', error);
                    updateStatus('ÏöîÏ≤≠Ïù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.');
                }
            } else {
                updateStatus('Ï∑®ÏÜåÌï† Ïàò ÏûàÎäî ÏöîÏ≤≠Ïù¥ ÏóÜÏäµÎãàÎã§.');
            }
        }


        function handleKeyPress(event) {
            if (event.key === 'Enter' && !isLoading) {
                sendMessage();
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        window.onload = function() {
            addSystemMessage('ÏÉàÎ°úÏö¥ ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÍ±∞ÎÇò Í∏∞Ï°¥ Ï±ÑÌåÖÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
            loadChats();
            loadDocuments();
            // Ï¥àÍ∏∞ÏóêÎäî ÏûÖÎ†• ÌïÑÎìú ÌôúÏÑ±Ìôî
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
        };

        // ÏÇ¨Ïö©ÏûêÎ™Ö Î≥ÄÍ≤Ω Ïãú Ï±ÑÌåÖ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        document.getElementById('userNameInput').addEventListener('change', function() {
            loadChats();
            loadDocuments();
        });

        // ÌååÏùº ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        document.getElementById('fileInput').addEventListener('change', updateSelectedFiles);

        // ÏóÖÎ°úÎìú Î™®Îìú Ï†ÑÌôò Ìï®Ïàò
        function toggleUploadMode() {
            const fileMode = document.getElementById('fileUploadMode');
            const folderMode = document.getElementById('folderUploadMode');
            const uploadBtn = document.getElementById('uploadBtn');
            const selectedMode = document.querySelector('input[name="uploadMode"]:checked').value;
            
            if (selectedMode === 'file') {
                fileMode.style.display = 'block';
                folderMode.style.display = 'none';
                uploadBtn.textContent = 'ÏóÖÎ°úÎìú';
            } else {
                fileMode.style.display = 'none';
                folderMode.style.display = 'block';
                uploadBtn.textContent = 'Ìè¥Îçî ÏóÖÎ°úÎìú';
            }
        }

        // ÌååÏùº ÏÑ†ÌÉù Ïãú Î™©Î°ù ÌëúÏãú
        function updateSelectedFiles() {
            const fileInput = document.getElementById('fileInput');
            const selectedFiles = document.getElementById('selectedFiles');
            const fileList = document.getElementById('fileList');
            
            if (fileInput.files.length > 0) {
                fileList.innerHTML = '';
                for (let i = 0; i < fileInput.files.length; i++) {
                    const li = document.createElement('li');
                    li.textContent = fileInput.files[i].name;
                    fileList.appendChild(li);
                }
                selectedFiles.style.display = 'block';
            } else {
                selectedFiles.style.display = 'none';
            }
        }

        // Î¨∏ÏÑú ÏóÖÎ°úÎìú Í¥ÄÎ†® Ìï®ÏàòÎì§
        async function uploadDocument() {
            const selectedMode = document.querySelector('input[name="uploadMode"]:checked').value;
            const userName = document.getElementById('userNameInput').value || 'user';
            
            if (selectedMode === 'file') {
                await uploadFiles();
            } else {
                await uploadFolder();
            }
        }

        // Í∞úÎ≥Ñ ÌååÏùº ÏóÖÎ°úÎìú (Ïó¨Îü¨ Í∞ú ÏßÄÏõê)
        async function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const folderName = document.getElementById('folderNameInput').value.trim();
            const userName = document.getElementById('userNameInput').value || 'user';
            
            if (!fileInput.files[0]) {
                showUploadStatus('ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            
            const files = Array.from(fileInput.files);
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ÏóÖÎ°úÎìú Ï§ë...';
            
            // ÏßÑÌñâÎ•† ÌëúÏãú
            showProgress();
            updateProgress(0, `0/${files.length} ÌååÏùº ÏóÖÎ°úÎìú Ï§ë...`);
            
            let successCount = 0;
            let errorCount = 0;
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('user_id', userName);
                    
                    if (folderName) {
                        formData.append('folder_id', folderName);
                    }
                    
                    try {
                        // 1. ÏóÖÎ°úÎìú ÏöîÏ≤≠ (Ï¶âÏãú ÏùëÎãµ)
                        const response = await fetch('/api/v1/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            const uploadId = data.data.document_id;
                            
                            // 2. ÏÉÅÌÉú Ï°∞Ìöå (Ìè¥ÎßÅ)
                            await pollUploadStatus(uploadId);
                            successCount++;
                        } else {
                            errorCount++;
                            console.error(`ÌååÏùº ${file.name} ÏóÖÎ°úÎìú Ïã§Ìå®:`, data.message);
                        }
                    } catch (error) {
                        errorCount++;
                        console.error(`ÌååÏùº ${file.name} ÏóÖÎ°úÎìú Ï§ë Ïò§Î•ò:`, error);
                    }
                    
                    // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
                    const progress = Math.round(((i + 1) / files.length) * 100);
                    updateProgress(progress, `${i + 1}/${files.length} ÌååÏùº ÏóÖÎ°úÎìú Ï§ë...`);
                }
                
                // Í≤∞Í≥º ÌëúÏãú
                if (successCount > 0) {
                    showUploadStatus(`ÏóÖÎ°úÎìú ÏôÑÎ£å: ${successCount}Í∞ú ÏÑ±Í≥µ, ${errorCount}Í∞ú Ïã§Ìå®`, 'success');
                } else {
                    showUploadStatus('Î™®Îì† ÌååÏùº ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                }
                
                // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                fileInput.value = '';
                document.getElementById('folderNameInput').value = '';
                updateSelectedFiles();
                await loadDocuments();
                
            } catch (error) {
                console.error('Upload error:', error);
                showUploadStatus(`ÏóÖÎ°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ÏóÖÎ°úÎìú';
                hideProgress();
            }
        }

        // Ìè¥Îçî ÏóÖÎ°úÎìú
        async function uploadFolder() {
            const folderPath = document.getElementById('folderPathInput').value.trim();
            const userName = document.getElementById('userNameInput').value || 'user';
            
            if (!folderPath) {
                showUploadStatus('Ìè¥Îçî Í≤ΩÎ°úÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Ìè¥Îçî ÏóÖÎ°úÎìú Ï§ë...';
            
            try {
                // Ìè¥Îçî ÏóÖÎ°úÎìú API Ìò∏Ï∂ú
                const formData = new FormData();
                formData.append('folder_path', folderPath);
                formData.append('user_id', userName);
                
                const response = await fetch('/api/v1/upload-folder', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showUploadStatus(`Ìè¥Îçî ÏóÖÎ°úÎìú ÏôÑÎ£å: ${data.uploaded_count}Í∞ú ÌååÏùº`, 'success');
                    document.getElementById('folderPathInput').value = '';
                    await loadDocuments();
                } else {
                    showUploadStatus(`Ìè¥Îçî ÏóÖÎ°úÎìú Ïã§Ìå®: ${data.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Folder upload error:', error);
                showUploadStatus(`Ìè¥Îçî ÏóÖÎ°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Ìè¥Îçî ÏóÖÎ°úÎìú';
            }
        }

        // ÏóÖÎ°úÎìú ÏÉÅÌÉú Ìè¥ÎßÅ Ìï®Ïàò
        async function pollUploadStatus(uploadId) {
            const maxAttempts = 60; // ÏµúÎåÄ 60Ï¥à ÎåÄÍ∏∞
            let attempts = 0;
            
            const poll = async () => {
                try {
                    const response = await fetch(`/api/v1/upload/${uploadId}/status`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        const status = data.data.status;
                        
                        if (status === 'processing') {
                            showUploadStatus('ÌååÏùºÏùÑ Ï≤òÎ¶¨ÌïòÍ≥† ÏûàÏäµÎãàÎã§...', 'success');
                            attempts++;
                            if (attempts < maxAttempts) {
                                setTimeout(poll, 1000); // 1Ï¥à ÌõÑ Îã§Ïãú ÌôïÏù∏
                            } else {
                                showUploadStatus('ÏóÖÎ°úÎìú ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§.', 'error');
                            }
                        } else if (status === 'completed') {
                            showUploadStatus('ÏóÖÎ°úÎìúÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!', 'success');
                        } else if (status === 'failed') {
                            showUploadStatus(`ÏóÖÎ°úÎìú Ïã§Ìå®: ${data.data.error}`, 'error');
                        }
                    } else {
                        showUploadStatus(`ÏÉÅÌÉú Ï°∞Ìöå Ïã§Ìå®: ${data.message}`, 'error');
                    }
                } catch (error) {
                    console.error('Status check error:', error);
                    showUploadStatus('ÏÉÅÌÉú ÌôïÏù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                }
            };
            
            await poll();
        }

        async function loadDocuments() {
            try {
                const userName = document.getElementById('userNameInput').value || 'user';
                const response = await fetch(`/api/v1/documents?user_id=${encodeURIComponent(userName)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                documents = data.data || [];
                displayDocuments();
                
            } catch (error) {
                console.error('Error loading documents:', error);
                showUploadStatus('Î¨∏ÏÑú Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        function displayDocuments() {
            const documentListDiv = document.getElementById('documentList');
            
            if (documents.length === 0) {
                documentListDiv.style.display = 'none';
                return;
            }
            
            documentListDiv.style.display = 'block';
            documentListDiv.innerHTML = '';
            
            documents.forEach(doc => {
                const docDiv = document.createElement('div');
                docDiv.className = 'document-item';
                
                const fileSize = formatFileSize(doc.file_size);
                const createTime = new Date(doc.create_dt).toLocaleString();
                
                docDiv.innerHTML = `
                    <div class="document-name" title="${doc.document_name}">
                        ${doc.document_name} (${fileSize})
                    </div>
                    <div class="document-actions">
                        <button class="document-btn download-btn" onclick="downloadDocument('${doc.document_id}')">Îã§Ïö¥Î°úÎìú</button>
                        <button class="document-btn delete-btn" onclick="deleteDocument('${doc.document_id}')">ÏÇ≠Ï†ú</button>
                    </div>
                `;
                
                documentListDiv.appendChild(docDiv);
            });
        }

        async function downloadDocument(documentId) {
            try {
                const userName = document.getElementById('userNameInput').value || 'user';
                const response = await fetch(`/api/v1/documents/${documentId}/download?user_id=${encodeURIComponent(userName)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // ÌååÏùºÎ™Ö Ï∂îÏ∂ú
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'document';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                // ÌååÏùº Îã§Ïö¥Î°úÎìú
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showUploadStatus('ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.', 'success');
                
            } catch (error) {
                console.error('Download error:', error);
                showUploadStatus(`Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`, 'error');
            }
        }

        async function deleteDocument(documentId) {
            if (!confirm('Ï†ïÎßêÎ°ú Ïù¥ Î¨∏ÏÑúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            try {
                const userName = document.getElementById('userNameInput').value || 'user';
                const response = await fetch(`/api/v1/documents/${documentId}?user_id=${encodeURIComponent(userName)}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showUploadStatus('Î¨∏ÏÑúÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
                    await loadDocuments();
                } else {
                    showUploadStatus(`ÏÇ≠Ï†ú Ïã§Ìå®: ${data.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Delete error:', error);
                showUploadStatus(`ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`, 'error');
            }
        }

        function showUploadStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.textContent = message;
            statusDiv.className = `upload-status ${type}`;
            statusDiv.style.display = 'block';
            
            // 3Ï¥à ÌõÑ ÏûêÎèô Ïà®ÍπÄ
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        // ÏßÑÌñâÎ•† ÌëúÏãú Ìï®ÏàòÎì§
        function showProgress() {
            const progressDiv = document.getElementById('uploadProgress');
            progressDiv.style.display = 'block';
        }

        function hideProgress() {
            const progressDiv = document.getElementById('uploadProgress');
            progressDiv.style.display = 'none';
        }

        function updateProgress(percent, text) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = `${percent}%`;
            progressText.textContent = text;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ÌååÏùº ÏÑ†ÌÉù Ïãú ÌååÏùºÎ™Ö ÌëúÏãú
        document.getElementById('fileInput').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const label = document.querySelector('.file-input-label');
                label.textContent = `üìé ${file.name}`;
            }
        });

        // Ï±ÑÌåÖÎ∞© Ïù¥Î¶Ñ Ìé∏Ïßë Ìï®Ïàò
        function editChatTitle(chatId, event) {
            event.stopPropagation(); // Ï±ÑÌåÖ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏ Î∞©ÏßÄ
            
            const roomElement = event.target.closest('.room-item');
            const roomNameElement = roomElement.querySelector('.room-name');
            const currentTitle = roomNameElement.textContent;
            
            // ÏûÖÎ†• ÌïÑÎìúÎ°ú Î≥ÄÍ≤Ω
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'room-name-input';
            input.value = currentTitle;
            input.maxLength = 50; // ÏµúÎåÄ 50Ïûê
            
            // Í∏∞Ï°¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†• ÌïÑÎìúÎ°ú ÍµêÏ≤¥
            roomNameElement.innerHTML = '';
            roomNameElement.appendChild(input);
            input.focus();
            input.select();
            
            // Ï†ÄÏû• Ìï®Ïàò
            const saveTitle = async () => {
                const newTitle = input.value.trim();
                if (newTitle && newTitle !== currentTitle) {
                    try {
                        const response = await fetch(`/api/v1/chat/chats/${chatId}/title?new_title=${encodeURIComponent(newTitle)}&user_id=user`, {
                            method: 'PUT'
                        });
                        
                        if (response.ok) {
                            roomNameElement.textContent = newTitle;
                            showMessage('Ï±ÑÌåÖÎ∞© Ïù¥Î¶ÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.', 'success');
                        } else {
                            const error = await response.json();
                            showMessage(`Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Ïã§Ìå®: ${error.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}`, 'error');
                            roomNameElement.textContent = currentTitle; // ÏõêÎûò Ïù¥Î¶ÑÏúºÎ°ú Î≥µÏõê
                        }
                    } catch (error) {
                        console.error('Error updating chat title:', error);
                        showMessage('Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                        roomNameElement.textContent = currentTitle; // ÏõêÎûò Ïù¥Î¶ÑÏúºÎ°ú Î≥µÏõê
                    }
                } else {
                    roomNameElement.textContent = currentTitle; // Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÏóÜÏúºÎ©¥ ÏõêÎûò Ïù¥Î¶ÑÏúºÎ°ú Î≥µÏõê
                }
            };
            
            // Ï∑®ÏÜå Ìï®Ïàò
            const cancelEdit = () => {
                roomNameElement.textContent = currentTitle;
            };
            
            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
            input.addEventListener('blur', saveTitle);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveTitle();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            });
        }
    </script>
</body>
</html>
